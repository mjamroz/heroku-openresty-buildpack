#!/usr/bin/env bash
set -euo pipefail

OPENRESTY_DIR="$HOME/openresty"
OPENRESTY_BIN="$OPENRESTY_DIR/nginx/sbin/nginx"
NGINX_CONF_DIR="$OPENRESTY_DIR/nginx/conf"
NGINX_DIR="$OPENRESTY_DIR/nginx"
SOURCE_NGINX_CONF="$NGINX_CONF_DIR/nginx.conf.default"
DEST_NGINX_CONF="$NGINX_CONF_DIR/nginx.conf"
DEST_NGINX_CONF2="$NGINX_CONF_DIR/nginx2.conf"

TEST_NGINX_CONF="$(mktemp --tmpdir="$NGINX_CONF_DIR" --suffix=-nginx.conf.test)"

cat <<- EOF | python - "$DEST_NGINX_CONF" > "$TEST_NGINX_CONF"
import sys
from os import environ
from jinja2 import Template

with open(sys.argv[1]) as f:
  content = f.read()

  try:
	  echo '-----> nginx-buildpack: try write port'
    template = Template(content)
    rendered = template.render(env=environ, **environ)
    sys.stdout.write(rendered)
  except:
	  echo '-----> nginx-buildpack: failed write port'
    for i, line in enumerate(content.splitlines(), start=1):
      sys.stderr.write("{0:>4}: {1}\n".format(i, line))

    raise
EOF

mv "$TEST_NGINX_CONF" "$DEST_NGINX_CONF2"
exec "$OPENRESTY_BIN" -p "$NGINX_DIR"  -c "$DEST_NGINX_CONF2"
